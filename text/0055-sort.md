- Title: Sort
- Start Date: 2021-07-20
- Specification PR: [#55](https://github.com/meilisearch/specifications/pull/55)
- MeiliSearch Tracking-issues:

# Sort

## 1. Functional Specification

### I. Summary

The purpose of this specification is to add the **sort** feature at search time in order to sort search results with ease. The so-called `sortable-attributes` fields must be known before the search to be usable. These fields can be of type `string` and `number`. We also introduced a new ranking rule named `sort` which allows the user to adjust how the sorting should behave. Is it more exhaustive or more relevant? It's up to the user. Also we introduce a `sort` parameter on the search endpoints in order to give the end user the ability to sort the search results.

#### Summary Key points

- `sortable-attributes` setting MUST be known by the engine before search time.
- `sort` search parameter MUST be able to operate on multiple fields at search time. `string` and `number`. e.g. sort="price:asc,label:desc,..."
- We add a new ranking rule `sort` which will be computed as soon as the search parameter `sort` is filled in and valid. The `sort` ranking rule allows to adjust the relevancy or the exhaustiveness of the sort.

### II. Motivation

According to our user feedback, the lack of a sorting feature is mentioned as one of the biggest deal-breakers when it comes to choosing MeiliSearch as a search engine. It is critical for a search engine to be able to offer this feature, especially for e-commerce use. Moreover, competitors all offer it. Users today must find workarounds that take time to develop and maintain to be able to sort search results.

We want to offer a simple and versatile solution for their needs.

### III. Explanation

#### **As a developer, I want to configure the sortable attributes so that the end-user can sort results.**

- Introduce a new field `sortableAttributes` in the global settings resource.
- Introduce a new sub-setting resource `/sortable-attributes`.

**Field definition**
`sortableAttributes` - Array[String] - Default: []

**GET settings** `/indexes/{indexUid}/settings`

200 - Response with empty `sortableAttributes` (default case)
```
{
    ...,
    "sortableAttributes": []
    ...
}
````

200 - Response with already configured sortableAttributes
```
{
    ...,
    "sortableAttributes": ["price", "released_date"]
    ...
}
````

üí° The values order in `sortableAttributes` has no impact. The order will be determined at search time.

**POST settings** `/indexes/{indexUid}/settings`

Request body
```
{
    ...,
	"sortableAttributes": ["price", "released_date", "title"],
    ...
}
```

202 Accepted - Response body
```
{
    "updateId": 7
}
```

- üí° Posting other than string value results in a 400 bad request - *invalid_request_error*.
- üí° Posting an inexistent field will not throw an error.
- üí° sortableAttributes accepts null and [] values to be reset.

**DELETE settings** `/indexes/{indexUid}/settings`

üí° Resetting all settings will result in default case e.g. sortableAttributes: []

202 Accepted - Response body
```
{
    "updateId": 8
}
```

**GET settings/sortable-attributes** `/indexes/{indexUid}/settings/sortable-attributes`

200 - Response body (Default case)
```
[]
```

200 - Response body with already configured `sortableAttributes`
```
[
    "price",
    "released_date"
]
```

- üí° If a master key is set and missing from the client, the `settings/sortable-attributes` resource is protected and return a 401 Unauthorized `missing_authorization_header`.
- üí° If the indexUid is not found a 404 Not Found response is returned.

**POST settings/sortable-attributes** `/indexes/{indexUid}/settings/sortable-attributes`

Request body
```
[
    "price",
    "released_date",
    "title"
]
```

202 Accepted - Response body
```
{
    "updateId": 7
}
```

- üí° Posting other than string value results in a 400 Bad Request `invalid_request_error`.
- üí° Posting an inexistent field will not throw an error.
- üí° Request body accept null and [] values to reset the `sortableAttributes`.
- üí° If a master key is set and missing from the client, the `settings/sortable-attributes` resource is protected and return a 401 Unauthorized `missing_authorization_header`.
- üí° If the indexUid is not found a 404 Not Found response is returned.

**DEL settings/sortable-attributes** `/indexes/{indexUid}/settings/sortable-attributes`

202 Accepted - Response body
```
{
    "updateId": 8
}
```
- üí° If a master key is set and missing from the client, the `settings/sortable-attributes` resource is protected and return a 401 Unauthorized `missing_authorization_header`.
- üí° If the indexUid is not found a 404 Not Found response is returned.

#### **As an End-User, I want to sort alphanumeric and numeric attributes in ascending/descending order so that I can find easily what I want when I'm searching**

- Introduce a `sort` query/body parameter on the search endpoints.

**GET Search /indexes/{indexUid}/search**

Query parameter `sort="price:asc,released_date:desc"`

**POST Search /indexes/{indexUid}/search**

Body
```
{
    ...,
    "sort": [
        "price:asc",
        "released_date:desc"
    ],
    ...
}
```

We need to align the custom ranking rules way of writing with the `sort` parameter syntax.

```
[
    "asc(title)",
    ...
]
```
become
```
[
    "title:asc"
]
```

**Search with sort example**

e.g. with this document set

```
[
    {
        "id": 1,
        "label": "Vans Classic II sweatshirt in black",
        "price": 52.00,
        "colors": ["black"],
        "sizes": ["xs", "s", "m", "m", "xl"],
        "reviews_rating": 4.5
    },
    {
        "id": 2,
        "label": "The North Face Drew Peak hoodie in green",
        "price": 36.00,
        "colors": ["green"],
        "reviews_rating": 4.89
    },
    {
        "id": 3,
        "label": "Nike Club hoodie in navy",
        "price": 52.00,
        "colors": ["navy"],
        "reviews_rating": 4.7
    }
]
```

e.g. with this ranking rules definition
```
[
    "sort",
    "typo",
    "sort",
    "proximity",
    "attribute",
    "exactness"
]
```

e.g. with this sortableAttributes definition
```
[
    "price",
    "reviews_rating"
]
```

**POST Search**

Request Body
```
{
    ...,
    "sort" = [
        "price:asc",
        "reviews_rating:desc"
    ]
}
```

200 - Response
```
{
    "hits": [
        {
            "id": 2,
            "label": "The North Face Drew Peak hoodie in green",
            "price": 36.00,
            "colors": ["green"],
            "reviews_rating": 4.89
        },
        {
            "id": 3,
            "label": "Nike Club hoodie in navy",
            "price": 52.00,
            "colors": ["navy"],
            "reviews_rating": 4.7
        },
        {
            "id": 1,
            "label": "Vans Classic II sweatshirt in black",
            "price": 52.00,
            "colors": ["black"],
            "sizes": ["xs", "s", "m", "m", "xl"],
            "reviews_rating": 4.5
        }
    ]
}
```

#### **As a Developer, I want to change the position of the `sort` ranking rule so that I tweak the behavior of the `sort` ranking rule between exhaustivity and relevancy.**

**GET settings/ranking-rules** `/indexes/{indexUid}/settings/ranking-rules`

200 - Response body (Default case)
```
[
    "words",
    "typo",
    "sort",
    "proximity",
    "attribute",
    "exactness"
]
```

**POST settings/ranking-rules**

Request body
```
[
    "sort",
    "words",
    "typo",
    "proximity",
    "attribute",
    "exactness"
]
```

202 Accepted - Response body
```
{
    "updateId": 7
}
```

- ‚ÑπÔ∏è The higher the `sort` ranking rule is ordered, the more the sorting will be important for exhaustivity. The lesser, the less it will be (the result will be more relevant to other ranking rules).

- üí° Names of non-existent ranking rules are not taken into account. So this doesn't return an error on a post request.

**Real condition explanation**

e.g. Relevant Sort

I want a relevant sort (sort on relevant items). I put sort at the latest level of my ranking rules so that it becomes a soft discrimant.

```
[
  "typo",
  "words",
  "proximity",
  "attribute",
  "exactness",
  "sort"
]
```

At search time, if I use (knowing that price and reviews_rating have been set as sortable-attributes previously)
```
{
    "q": "Mac Book",
    "sort": [
        "price:asc",
        "reviews_rating:desc"
    ]
}
```

Ranking rules can virtually be represented that way for this search request.

```
[
  "typo",
  "words",
  "proximity",
  "attribute",
  "exactness",
  "price:asc", //first part of the `sort` ranking rule.
  "reviews_rating:desc" //second part of the `sort`ranking rule.
]
```

Note that is I change the request parameter order, it change the inner element of `sort` ranking rule.

```
{
    "q": "Mac Book",
    "sort": [
        "reviews_rating:desc",
        "price:asc"
    ]
}
```

```
[
  "typo",
  "words",
  "proximity",
  "attribute",
  "exactness",
  "reviews_rating:desc" //the order of inner elements of the sort ranking rule is made from the order of the `sort` query/request parameter.
  "price:asc",
]
```

### IV. Finalized Key Changes

- Add `sortableAttributes` parameter in settings schema.
- Add `sortable-attributes` API ressource.
- Add a `sort` ranking rule.
- Add `sort` query/request parameter on `/search` ressource.